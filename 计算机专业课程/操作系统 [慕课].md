# 引言

## 学什么

**思想/架构**

- 操作系统为什么这么设计
- 多线程为什么这么设计

**实现/算法**

- 并发算法/相关数据结构
- 文件系统如何实现？内存回收如何处理？

**底层**

- 内核是怎么工作的？
- 进程/线程/程序在操作系统里是什么？

**个人看法**

- 上操作系统课的时候，老师说过一句话，我印象很深。“我们学OS不是为了写出这样的软件，我们也没有能力写出，我们学OS是学习OS发展过程中提出的问题，发现的问题，如何解决的“。OS中的许多设计理念，算法的确很经典，也有不少中间件或多或少的用到了这些思想，这些是十分值得我们学习的。
- 怎么算学到了OS？我不好概括，用举例子的方式说明吧。
  - 有一类数据访问很频繁，你联想到了OS的缓存，于是你把那些访问频繁的数据放到了内存中，避免每次访问都进行IO操作。
  - 数据不仅需要访问，还需要替换。于是，你想到了OS的页面置换策略，你采用LRU算法进行数据的置换。
  - 这应该是redis比较常见的操作，而redis的这些设计理念，算法，在很大程度上是借鉴了操作系统中的设计。

## 弱项

之前学OS，文件系统那块的设计不清楚，学的不连贯。

# OS概述

## 什么是OS

不少教程上都有定义，这里不大面积抄书了。

操作系统是管理计算机软硬件资源的系统软件。它负责分配系统资源，对进程/线程进行调度，管理OS中的文件，管理内存等等。OS的出现就是为了合理管理，分配计算机软硬件资源的。将这些资源抽象成服务，供程序使用。

- 管理硬件设备、资源以及应用程序（管理能力）
- 将硬件能力、资源抽象成服务让应用程序使用（抽象能力）



**开机-->BOIS-->引导程序-->操作系统**

<img style="margin:left" src="../pics/os_mooc/os_abstract_01.png">

## OS的历史

# 进程和多线程

# 调度算法



# 内存管理

## 虚拟内存★

如：将32kb的物理内存抽象为64kb

页表（虚拟内存）表示64kb，页表中的页表项指向物理内存（页框）。

页表是被加载到了物理内存中。我们用一小部分的物理内存存放页表。



每次都需要把虚拟内存映射到物理内存，性能如何保证？

内存管理单元（Memory Management Unit）

MMU位于CPU内部，可以通过硬件电路完成内存映射。

# 文件管理



## 文件系统和磁盘

### 常见的文件系统

FAT（File Allocate Table，文件分配表）

- FAT16、FAT32

Ext2（second extended file system）

NTFS（NT File System）日志文件系统，记录发生什么，而不是结果

### 文件和目录

目录是一种特殊的文件，它是用来对文件进行分类的。

- 目录中会有对一个或多个文件的引用。

### 磁盘

- 机械硬盘
- 固态硬盘

### 空闲物理块

基于链表的空闲管理（类比基于链表的内存管理）

基于位图的空闲块管理

### 魔数

用来区分文件类型的。

如Java.class文件，开头四个字节是 ： 0xCAFEBABE

DOS可执行文件开头0x00004550

## 文件和文件的表示

### 文件

磁盘上信息的一种抽象，把信息抽象成拥有名字的一个集合。

不同文件系统对文件的表示方法不同，但提供相似的操作接口（POSIX标准，Portable Operating System Interface）

### 文件的实现方式

- 连续分配：文件被分成若干个块，在磁盘上连续分配
  - 存在碎片化问题。需要碎片整理

- 链表分配：文件分成多个节点，用链表串起来
  - 节点尾部要存储下一个节点的位置。（这种叫隐式链接吗？）

- 内存中的链表分配（FAT）
  - 把节点的位置和下一个节点的位置存储在内存中。（这种叫显式链接吗？）
  - 内存中有一个FAT表，类似于数据结构中的静态链表。
  - 1T的硬盘，每个块4K需要多大的FAT表？
    - 1T = 2^30 k
    - 1T / 4k = 1G 内存。需要的内存太大了。

- index-node（会有文件打开数量限制）
  - 一级索引，二级索引，三级索引，最后指向磁盘块。看OS书！

## 共享文件和目录

目录也是文件！目录记录了文件的一些信息！

如：目录中记录了 文件的长度，属性，文件名，ino

de指针。

文件共享

- 单级目录
- 多级目录

- 链接
  - 硬链接：存指针
  - 软链接：存路径，有寻址过程，效率较低。 
  - 