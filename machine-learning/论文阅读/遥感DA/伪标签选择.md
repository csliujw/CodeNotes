# Rectifying Pseudo Label Learning via Uncertainty Estimation for Domain Adaptive Semantic Segmentation

# 翻译

## Abstract

本文重点研究语义分割上下文中将知识从源域转移到目标域的无监督域自适应。 现有方法通常将伪标签视为基本事实（真实标签），以充分利用未标记的目标域数据。 然而，目标域数据的伪标签通常由在源域上训练的模型预测。 因此，**由于训练域和测试域之间的差异，生成的标签不可避免地包含不正确的预测，这可能会转移到最终的适应模型中并在很大程度上损害训练过程**

为了克服这个问题，本文提出在训练期间明确估计预测不确定性，以纠正无监督语义分割适应的伪标签学习。给定输入图像，模型输出语义分割预测以及预测的不确定性。具体来说，我们通过预测方差（prediction variance）对不确定性进行建模，并将不确定性纳入优化目标。为了验证所提出方法的有效性，我们在两个流行的合成到真实语义分割基准，即 GTA5 → Cityscapes 和 SYNTHIA → Cityscapes，以及一个跨城市基准，即Cityscapes → Oxford 上评估所提出的方法机器人车。我们通过大量实验证明，所提出的方法 (1) 根据预测方差（prediction variance）动态设置不同的置信阈值，(2) 纠正从嘈杂伪标签中的学习，以及 (3) 对传统伪标签学习取得显着改进，并在所有三个基准测试中的表现出有竞争力的结果。

## Introduction

深度神经网络 (DNN) 已在语义分割领域得到广泛采用，产生了最先进的性能 [Liang et al., 2017, Wei et al., 2018]。然而，最近的工作表明，DNN 对未知环境的可扩展性有限，例如在雨天收集的测试数据 [Hendrycks 和 Dietterich，2019 年，Wu 等人，2019 年]。一个简单的想法是注释更多目标环境的训练数据，然后重新训练分割模型。然而，语义分割任务通常需要密集的注释，并且在新环境中为收集的数据手动注释像素级标签是负担不起的。因此，为了应对这一挑战，研究人员采用了无监督的语义分割适应，这更接近现实世界的实践。在无监督语义分割自适应中，考虑了在不同环境中收集的两个数据集：一个标记的源域数据集，其中为每个像素提供类别标签，以及一个未标记的目标域数据集，仅提供没有注释的收集数据。与目标域中的标注数据相比，未标注数据通常更容易收集。语义分割自适应旨在利用标记的源域数据和未标记的目标域数据使训练有素的模型适应目标环境。

语义分割自适应的主要挑战是源域和目标域之间数据分布的差异。语义分割自适应有两种方法。一方面，一些现有的工作通过最小化不同级别的分布差异来专注于域对齐，例如像素级别 [Wu et al., 2018, Wu et al., 2019, Hoffman et al., 2018]、特征级别[Huang et al., 2018, Yao et al., 2019, Luo et al., 2019a, Zhang et al., 2019b] 和语义层面 [Tsai et al., 2018,Tsai et al., 2019,Wang et al. ., 2019]。尽管取得了巨大的成功，**但这项工作并不理想。因为对齐目标驱动模型学习领域之间的共享知识，但忽略了领域特定的知识。特定领域的知识是最终目标的关键之一，即适应目标领域的模型**。另一方面，一些研究人员专注于通过充分利用未标记的目标域数据来学习目标域的特定领域知识[邹 et al., 2018,Zou et al., 2019, Han et al., 2019]。具体来说，这一系列方法通常采用两阶段流水线，类似于传统的半监督框架 [Lee, 2013]。第一步是通过从标记数据中学到的知识来预测伪标签，例如在源域上训练的模型。第二步是最小化未标记目标域数据的伪标签上的交叉熵损失。在训练过程中，伪标签通常被视为优化模型的准确注释。  

然而，基于伪标签的场景适应方法存在一个固有问题。**伪标签通常会受到在不同数据分布上训练的模型引起的噪声的影响（见图 1）。嘈杂的标签可能会影响后续的学习。**尽管一些现有的工作 [Zou et al., 2018,Zou et al., 2019] 已经提出手动设置阈值以忽略低置信度伪标签，它在几个方面仍然具有挑战性：**首先，对于不同的目标域，阈值的值很难确定。**它取决于源域和目标域的相似度，很难提前估计。**其次，不同类别的阈值也难以确定。**例如，交通标志等目标很少出现在源域中。稀有类别的整体置信度得分相对较低。高阈值可能会忽略稀有类别的信息。**第三，阈值也与像素的位置有关。例如，目标中心的像素，如汽车，相对容易预测，而目标边缘的像素通常面临模糊的预测。**<span style="color:green">它反映了阈值不仅要考虑置信度得分，还要考虑像素的位置。</span>总之，分割图中的每个像素都需要区别对待。固定的门槛很难满足需求。

为了解决上述挑战，我们提出了一种**通过建模不确定性**来适应语义分割的简单有效的方法，该方法可以自动为输入图像提供像素级阈值。 在不引入额外参数或模块的情况下，我们将不确定性公式化为预测方差。 预测方差以bootstrapping manner 方式反映模型对预测的不确定性。 同时，我们明确地将方差纳入优化目标，称为方差正则化，它用作自动阈值并与标准交叉熵损失兼容。 自动阈值纠正了从嘈杂标签中的学习，并确保以连贯的方式进行训练。 因此，所提出的方法可以有效地利用伪标签提供的域特定信息，并利用未标记的目标域数据。 

本文的贡献如下：

- 据我们所知，我们是最早尝试利用不确定性估计并从嘈杂的伪标签中自动学习阈值。 这与直接利用噪声伪标签或手动设置置信阈值的大多数现有域适应方法形成对比。
- 在不引入额外参数或模块的情况下，我们将不确定性公式化为预测方差。 具体来说，**我们引入了一个新的正则化项，方差正则化，它与标准交叉熵损失兼容**。 方差正则化用作自动阈值，并纠正从嘈杂伪标签中的学习。
- 我们在两个综合到真实的基准和一个跨城市基准上验证了所提出的方法。 所提出的方法比传统的伪标签学习取得了显着的改进，与现有方法相比具有竞争力。

## Related work

### Semantic Segmentation Adaptation

无监督域自适应的主要挑战是源域和目标域之间的数据分布不同。为了应对这一挑战，一些开创性的工作提出将源域数据的视觉风格转移到目标域。通过这种方式，可以在具有目标风格的标记数据上训练模型。同样，最近的一些工作利用 Adversarial Domain Adaptation 将源域图像或特征转移到多个域，并打算学习域不变特征。此外，一些工作侧重于神经网络中间激活之间的对齐。罗等人。利用注意力机制来细化特征对齐。除了修改视觉外观，高级语义特征之间的对齐也引起了很多关注。蔡等人。建议利用鉴别器来要求两个域之间的相似语义输出。综上所述，这一系列方法侧重于对齐，学习源域和目标域之间的共享知识。然而，特定领域的信息通常被忽略，这是在目标环境中适应的关键之一。因此，在本文中，我们求助于另一条基于伪标签学习的方法。

### Pseudo label learning

另一种语义分割自适应方法利用伪标签使模型适应目标域 [Zou et al., 2018, Zou et al., 2019, Zheng and Yang, 2020]。主要思想接近于传统的半监督学习方法，即熵最小化，它首先被提出来利用未标记的数据 [Grandvalet 和 Bengio，2005]。熵最小化鼓励模型以更高的置信度给出预测。在实践中，里德等人。 [Reed et al., 2014] 提出通过熵最小化进行引导，并展示了在目标检测和情感识别方面的有效性。此外，Lee 等人。 [Lee, 2013] 利用经过训练的模型来预测未标记数据的伪标签，然后微调模型作为监督学习方法以充分利用未标记数据。最近，潘等人。 [Pan et al., 2019] 利用伪标签学习来最小化目标域数据与源域原型的分布。对于无监督语义分割，Zou 等人。 [Zou et al., 2019,Zou et al., 2018] 将伪标签策略引入语义分割自适应，并对正则化术语进行了综合分析。本着类似的精神，Zheng 等人。 [Zheng and Yang, 2020] 还应用伪标签来学习特定领域的特征，从而产生有竞争力的结果。然而，伪标签学习的一个固有弱点是伪标签通常包含嘈杂的预测。尽管大多数伪标签是正确的，但也存在错误的标签，这可能会影响后续的训练。如果模型在嘈杂的标签上进行了微调，误差也会转移到适应模型中。与现有工作不同，我们不平等对待伪标签，并打算纠正从嘈杂标签中学习。在微调模型时，所提出的方法明确预测伪标签的不确定性。不确定性可以被视为调整从嘈杂标签学习的自动阈值。

### 2.3 Co-training

协同训练是一种半监督学习方法，它需要两个分类器来学习互补信息 [Blum 和 Mitchell，1998]。一些领域适应工作也探索了类似的学习策略。 [Saito et al., 2018, Luo et al., 2019b] 通过引入一个额外的损失，即 [Saito et al., 2018] 中的 Ladv 和 [Luo et al., 2019b] 中的 Lweight，明确地最大化了两个分类器的差异。 , 2019b]，以获得互补分类器。 [Saito et al., 2018] 通过对抗性训练最小化特征差异。同样，[Luo et al., 2019b] 将分类器差异应用于鉴别器损失以稳定训练。相比之下，由于我们在不同的中间层部署了两个分类器，因此所提出的方法使分类器本质上存在差异。我们不会引入这样的损失来鼓励分类器的差异。否则，每个伪标签都将是高不确定性的。例如，如果两个分类器输出一个相同类别的预测，我们就不会惩罚网络。相比之下，[Saito et al., 2018] 将惩罚分类器以进行对抗训练。此外，[Saito et al., 2018,Luo et al., 2019b] 仍然使用传统的分割损失并且不处理噪声标签，当所提出的方法使用分类器差异来纠正分割时的伪标签学习时。 

### 2.4 Uncertainty Estimation

为了解决噪声，现有工作从不同方面探索了不确定性估计，例如输入数据、注释和模型权重。在这项工作中，我们专注于注释的不确定性。我们的目标是学习一个可以预测注释是否正确的模型，并从嘈杂的伪标签中学习。在现有工作中，贝叶斯网络被广泛用于预测网络中权重的不确定性 [Nielsen and Jensen, 2009]。本着类似的精神，肯德尔等人。 [Kendall and Gal, 2017] 将贝叶斯理论应用于计算机视觉任务的预测，并打算不仅提供预测结果，还提供预测的置信度。此外，Yu 等人。 [Yu et al., 2019] 通过额外的辅助分支明确地对不确定性建模，并将随机噪声纳入训练。该模型可以明确地估计特征均值和预测方差。受上述工作的启发，**我们建议利用预测方差来制定不确定性**。以前的工作和我们的工作有两个根本区别：**（1）我们没有引入额外的模块或参数来模拟噪声。**相反，我们利用分割模型中的预测差异。 **(2) 我们明确地将不确定性纳入训练目标**，并采用自适应方法自动学习像素级不确定性图。所提出的方法不需要手动设置阈值来强制执行伪标签学习。 

## Methodology

在 3.1 节中，我们首先提供问题的定义和外延。 然后我们重新审视基于伪标签的传统域适应方法并讨论伪标签学习的局限性（见第 3.2 节）。 为了解决上述限制，我们建议利用不确定性估计。 特别是，**我们将不确定性表述为预测方差**，并在 3.3 节中提供了一个简要定义，然后是提议的方差正则化，它与 3.4 节中的标准交叉熵损失兼容。 此外，在第 3.5 节中提供了实现细节。

### Problem Definition