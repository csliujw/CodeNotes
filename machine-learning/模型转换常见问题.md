# tflite 定点模型问题

## 精度下降的厉害

- 归一化方式的问题。如归一化到 【0，1】和【-1，-1】在 FP32 下精度差异不大，在 uint8 下差异较大。 
- 算子不适配，需要更换算子。如本地推理环境支持 PReLU 算子，但是部署的终端不支持。

## 输出结果异常

- 如，yolo 模型输出值应该是 xywh，score 和 classes。xywh 是大于 1 的数 score 的值要么是 0，要么都大于 1（比如都是 14.xxx），这种情况是需要做归一化的，将 score 和 xywh 归一化到一个尺度范围内，如（0，1）即可。
- 如，在 uint8 模式下，mesh 模型的输出值应该是 x,y,z 其中 z 可能为负数，这时候可以在模型端对输出的值做处理，统一加上一个值，使 z 的输出为正数，推理得到结果后再反归一化。也可以将输入输出的类型改为 int8，这样是否就支持了负数？（未验证）

## tflite注意事项

- 默认情况 output 的 max=1， min=0；对 mesh 模型而已，将 max 修改为 10，100 会比默认的值 1 好一些。
- Tflite 如果输入数据的范围是（0，1），mean 和 std 应该是：mean=0，std=255；如果输入数据的范围是（-1，1），mean 和 std 应该是：mean=127.5，std=127.5
- netron 可视化的时候如果发现了 tflite 中没有该类算子，大概率是不支持，需要用支持的算子进行替换。
- 如果后处理没有做好模型量化可能会失败。版本问题也需要注意。
- onnx2tflite 的算子
- 算子适配问题相关文档
    - https://tensorflow.google.cn/lite/performance/hexagon_delegate?hl=zh-cn
    - https://github.com/tensorflow/tensorflow/blob/master/tensorflow/lite/delegates/hexagon/README.md

## yolo一类模型转换的坑

- 目前已知 tnn、tflite 不支持五个维度的通道转换。需要变成四维的通道转换，但是！在替换的时候一定要注意加上contiguous()！！论文原版代码里加了！你就要加！这种往往是不希望你更新原有的值，因为原有的值可能要进行一些其他操作，诸如特征融合。下面是一份参考代码。

```Python
def forward(self, x):
    z = []  # inference output
    if self.export_cat:
        for i in range(self.nl):
            x[i] = self.m[i](x[i])  # conv
            _,_, ny, nx = x[i].shape  # x(bs,255,20,20) to x(bs,3,20,20,85)
            # 这样就好了！要 contiguous？
            yy = x[i].view(self.na, self.no, ny, nx).permute(0, 2, 3, 1).contiguous()

            self.grid[i], self.anchor_grid[i] = self._make_grid_new(nx, ny,i)
            yy = yy.sigmoid()
            box_xy,box_wh,conf,label = yy[...,:2],yy[...,2:4],yy[...,4:5],yy[...,15:16]

            box_xy = (box_xy * 2. - 0.5 + self.grid[i][0].to(x[i].device)) * self.stride[i] # xy
            box_wh = (box_wh * 2) ** 2 * self.anchor_grid[i][0] # wh
            box_xy = box_xy / 256.
            box_wh = box_wh / 256.

            y = torch.cat((box_xy,box_wh,conf,label),3)
            z.append(y.view(1, -1, 6))
        return torch.cat(z, 1)
```

## 量化相关内容

- https://blog.csdn.net/jin739738709/article/details/113244053
- https://blog.csdn.net/chen1234520nnn/article/details/118543638?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-1-118543638-blog-127716931.pc_relevant_aa&spm=1001.2101.3001.4242.2&utm_relevant_index=4

# TensorRT 定点模型问题

# 算子适配问题

## tflite 算子适配

- 不支持五维度的通道转换。
- 推理出现问题时，对照官方文档查阅模型中是否存在不适配的算子。

## tnn 算子适配问题

- 不支持五维度的通道转换
- 推理出现问题时，对照官方文档查阅模型中是否存在不适配的算子。
- 社区比较活跃，issue 比较多，可以直接从 issue 中查找可能的答案。

