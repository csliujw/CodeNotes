<!-- GFM-TOC -->
* [域名系统](#域名系统)
* [文件传送协议](#文件传送协议)
* [动态主机配置协议](#动态主机配置协议)
* [远程登录协议](#远程登录协议)
* [电子邮件协议](#电子邮件协议)
    * [1. SMTP](#1-smtp)
    * [2. POP3](#2-pop3)
    * [3. IMAP](#3-imap)
* [常用端口](#常用端口)
* [Web 页面请求过程](#web-页面请求过程)
    * [1. DHCP 配置主机信息](#1-dhcp-配置主机信息)
    * [2. ARP 解析 MAC 地址](#2-arp-解析-mac-地址)
    * [3. DNS 解析域名](#3-dns-解析域名)
    * [4. HTTP 请求页面](#4-http-请求页面)
<!-- GFM-TOC -->



# 网络应用模型

## 客户/服务器模型

> 客户请求服务，服务器提供服务

**工作流程如下**

- 服务器处于接收请求的状态。
- 客户机发出服务请求，等待接收结果。
- 服务器收到请求后，分析请求，进行必要处理，得到结果并发送给客户机。

## P2P模型

C/S模型中，服务器的性能好坏决定了整个系统的性能，请求量过大时，服务器无法承受，导致崩溃。

P2P思想是：整个网络中的传输内容不再被保存在中心服务器上，每个结点都同时具有下载、上传的功能，权力与义务对等。无固定的客户和服务器划分。

**优点**

- 减轻的服务器的计算压力，消除了对某个服务器的完全依赖，可将任务分配到各节点上，提高了系统效率和资源利用率。【比如百度的激励计划，服务器下载压力过大时，利用你的电脑作为服务器提供下载功能；播放流媒体时对服务器的压力过大，而通过P2P模型，利用大量的客户机来提供服务】

**缺点**



# 域名系统（DNS）

DNS系统采用客户/服务器模型，其协议运行在UDP之上，使用53端口，用于处理主机名与IP地址的转换（机器处理IP地址更为容易）

DNS 是一个分布式数据库，提供了主机名和 IP 地址之间相互转换的服务。这里的分布式数据库是指，每个站点只保留它自己的那部分数据。

域名具有层次结构，从上到下依次为：根域名、顶级域名、二级域名。

<div align="center"> <img src="pics/b54eeb16-0b0e-484c-be62-306f57c40d77.jpg"/> </div><br>

DNS 可以使用 UDP 或者 TCP 进行传输，使用的端口号都为 53。大多数情况下 DNS 使用 UDP 进行传输，这就要求域名解析器和域名服务器都必须自己处理超时和重传从而保证可靠性。在两种情况下会使用 TCP 进行传输：

- 如果返回的响应超过的 512 字节（UDP 最大只支持 512 字节的数据）。
- 区域传送（区域传送是主域名服务器向辅助域名服务器传送变化的那部分数据）。

**DNS域名解析**

假设客户机想获知域名为y.abc.com主机的IP地址

- 客户机向其本地域名服务器发出DNS请求报文
- 本地域名服务器接收到请求和，查询本地缓存，假设无该记录，则以DNS客户的身份向根域名服务器发出解析请求。
- 根域名服务器接收到请求后，判断该域名属于.com域；将对应的顶级域名服务器dns.com的IP地址返回给本地域名服务器。
- 本地域名服务器向顶级域名服务器dns.com发出解析请求报文。
- 顶级域名服务器dns.com收集到请求后，判断该域名属于abc.com域，故将对应的授权域名服务器dns.abc.com的IP地址返回给本地域名服务器。
- 本地域名服务器向授权域名服务器dns.abc.com发出解析请求报文。
- 授权域名服务器dns.abc.com收到请求后，将查询结果返回给本地域名服务器。
- 本地域名服务器将查询结果保存到本地缓存，同时返回给客户机。

> **一句话：发送请求，得到解析结果，全部解析完毕，缓存起来。**

为提高DNS的效率，会设置高速缓存，避免频繁的解析同一个域名而浪费机器性能。缓存有有效期。【**缓存的作用无处不在啊！**】

# 文件传送协议FTP

> **FTP提供交互式访问，允许客户指明文件的类型与格式，并允许文件具有存取权限。屏蔽了计算机系统的细节，适用于异构网络中任意计算机之间传送文件。**

FTP 使用 TCP 进行连接【文件传输要求严格，不允许有丢失】，它需要两个连接来传送一个文件：

- 控制连接：服务器打开端口号 21 ，等待客户端的连接请求，客户端主动建立连接后，使用这个连接将客户端的命令传送给服务器，并传回服务器的应答。
- 数据连接：用来传送一个文件数据。

根据数据连接是否是服务器端主动建立，FTP 有主动和被动两种模式：

- **主动模式：服务器端主动建立数据连接，**其中服务器端的端口号为 20，客户端的端口号随机，但是必须大于 1024，因为 0\~1023 是熟知端口号【避免端口冲突】。

<div align="center"> <img src="pics/03f47940-3843-4b51-9e42-5dcaff44858b.jpg"/> </div><br>

- **被动模式：客户端主动建立数据连接，**其中客户端的端口号由客户端自己指定，服务器端的端口号随机。

<div align="center"> <img src="pics/be5c2c61-86d2-4dba-a289-b48ea23219de.jpg"/> </div><br>

主动模式要求客户端开放端口号给服务器端，需要去配置客户端的防火墙。被动模式只需要服务器端开放端口号即可，无需客户端配置防火墙。但是被动模式会导致服务器端的安全性减弱，因为开放了过多的端口号。

# 动态主机配置协议

DHCP (Dynamic Host Configuration Protocol) 提供了即插即用的连网方式，用户不再需要手动配置 IP 地址等信息。

DHCP 配置的内容不仅是 IP 地址，还包括子网掩码、网关 IP 地址。

DHCP 工作过程如下：

1. 客户端发送 Discover 报文，该报文的目的地址为 255.255.255.255:67，源地址为 0.0.0.0:68，被放入 UDP 中，该报文被广播到同一个子网的所有主机上。如果客户端和 DHCP 服务器不在同一个子网，就需要使用中继代理。
2. DHCP 服务器收到 Discover 报文之后，发送 Offer 报文给客户端，该报文包含了客户端所需要的信息。因为客户端可能收到多个 DHCP 服务器提供的信息，因此客户端需要进行选择。
3. 如果客户端选择了某个 DHCP 服务器提供的信息，那么就发送 Request 报文给该 DHCP 服务器。
4. DHCP 服务器发送 Ack 报文，表示客户端此时可以使用提供给它的信息。

<div align="center"> <img src="pics/23219e4c-9fc0-4051-b33a-2bd95bf054ab.jpg"/> </div><br>

# 远程登录协议

TELNET 用于登录到远程主机上，并且远程主机上的输出也会返回。

TELNET 可以适应许多计算机和操作系统的差异，例如不同操作系统系统的换行符定义。

# 电子邮件协议

> **电子邮件：异步通信**

**一个电子邮件系统由三部分组成：<u>用户代理</u>、<u>邮件服务器</u>  以及 <u>邮件协议（如SMTP，POP3，IMAP）</u>。**

邮件协议包含**发送协议**和**读取协议**，**发送协议常用 SMTP**，**读取协议常用 POP3 和 IMAP。**

<div align="center"> <img src="pics/7b3efa99-d306-4982-8cfb-e7153c33aab4.png" width="700"/> </div><br>

## 1. SMTP

SMTP 只能发送 ASCII 码，而互联网邮件扩充 MIME 可以发送二进制文件。MIME 并没有改动或者取代 SMTP，而是增加邮件主体的结构，定义了非 ASCII 码的编码规则。

<div align="center"> <img src="pics/ed5522bb-3a60-481c-8654-43e7195a48fe.png" width=""/> </div><br>

## 2. POP3

POP3 的特点是只要用户从服务器上读取了邮件，就把该邮件删除。

## 3. IMAP

IMAP 协议中客户端和服务器上的邮件保持同步，如果不手动删除邮件，那么服务器上的邮件也不会被删除。IMAP 这种做法可以让用户随时随地去访问服务器上的邮件。

# 常用端口

|应用| 应用层协议 | 端口号 | 传输层协议 | 备注 |
| :---: | :--: | :--: | :--: | :--: |
| 域名解析 | DNS | 53 | UDP/TCP | 长度超过 512 字节时使用 TCP |
| 动态主机配置协议 | DHCP | 67/68 | UDP | |
| 简单网络管理协议 | SNMP | 161/162 | UDP | |
| 文件传送协议 | FTP | 20/21 | TCP | 控制连接 21，数据连接 20 |
| 远程终端协议 | TELNET | 23 | TCP | |
| 超文本传送协议 | HTTP | 80 | TCP | |
| 简单邮件传送协议 | SMTP | 25 | TCP | |
| 邮件读取协议 | POP3 | 110 | TCP | |
| 网际报文存取协议 | IMAP | 143 | TCP | |

# 万维网

## 万维网的概念与组成

万维网www（world wide web）：一个资料空间，是无数个网络站点和网页的集合。

**万维网的内核：**

- 统一资源定位符URL，负责标识万维网上的各种文档
- 超文本传输协议（HTTP），应用层协议，使用TCP进行可靠的传输
- 超文本标记语言，文档结构的标记语言，使用约定的标记对页面上的信息、格式进行描述

**工作流程：**（回忆tomcat的运作）

web用户使用浏览器（指定URL）与web服务器建立连接，并发送浏览请求

web服务器把url转化维文件路径，并返回信息给web浏览器

通信完成，关闭连接

## 超文本传输协议HTTP

> 规定了浏览器和服务器之间的请求和响应的格式和规则

**执行流程如下：**（以访问www.baidu.com为例）

- 浏览器分析链接指向页面的URL（http://www.baidu.com）
- 浏览器向DNS请求解析www.baidu.com的IP地址
- 域名系统解析出百度的IP地址**（域名解析先解析com，在解析baidu，在解析www）**
- 浏览器与该服务器建立TCP链接（不指定端口的话就是，默认端口80）
- 浏览器发出HTTP请求：GET /index.html
- 服务器通过HTTP响应把文件index.html发送给浏览器
- TCP释放连接
- 浏览器将文件index.html进行解释，并将web页显示给用户。

**HTTP协议的特点**

- 无状态；虽然使用了面向连接的TCP（运输层）协议，但HTTP协议本身是一个无状态协议。HTTP不要求服务器保留客户的任何状态信息，且不会影响下一次的访问。

- 无连接；虽采用TCP作为运输层协议，保证了数据传输的可靠性，但是HTTP本身不用考虑数据在传输过程中被丢弃后如何重传。通信双方在交换HTTP报文之前不需要建立HTTP连接。

- HTTP既可以采用非持久连接也可以采用持久连接

  - **HTTP/1.0采用非持续连接**，一次响应对应一个TCP连接。在非持续连接方式中，每次浏览器要请求一个文件都要与服务器进行TCP连接，当收到响应后就立即关闭（**开销是不是太大了**）【**每次建立新的TCP连接都要分配缓存和变量并初始化各种状态**】

    从请求文档到接收文档的时间 = 2RTT。三次握手+把请求文档作为响应报文返回给客户。三次握手的第三次，浏览器会把HTTP请求报文放上去，作为TCP的确认报文的数据发送给服务器（前两部分不能携带数据）。

    **缺点**：每请求一个文档就要有两倍的RTT的开销！

  - **HTTP/1.1协议使用持续连接**

    持续连接，万维网发送响应后仍然保持这条连接，使同一个客户（浏览器）和该服务可以继续在这条连接上传送后续的HTTP请求报文和响应报文。【不局限于同一个页面上的引用对象，而是只要这些文档在同一个服务器上就行】

    持续连接又分为流水线和非流水线。对于非流水线，客户在收到一个响应后才能发出下一个请求。流水线方式，在收到HTTP响应报文之前就连续发送多个请求报文。

# Web 页面请求过程

## 1. DHCP 配置主机信息

- 假设主机最开始没有 IP 地址以及其它信息，那么就需要先使用 DHCP 来获取。

- 主机生成一个 DHCP 请求报文，并将这个报文放入具有目的端口 67 和源端口 68 的 UDP 报文段中。

- 该报文段则被放入在一个具有广播 IP 目的地址(255.255.255.255) 和源 IP 地址（0.0.0.0）的 IP 数据报中。

- 该数据报则被放置在 MAC 帧中，该帧具有目的地址 FF:<zero-width space>FF:<zero-width space>FF:<zero-width space>FF:<zero-width space>FF:FF，将广播到与交换机连接的所有设备。

- 连接在交换机的 DHCP 服务器收到广播帧之后，不断地向上分解得到 IP 数据报、UDP 报文段、DHCP 请求报文，之后生成 DHCP ACK 报文，该报文包含以下信息：IP 地址、DNS 服务器的 IP 地址、默认网关路由器的 IP 地址和子网掩码。该报文被放入 UDP 报文段中，UDP 报文段有被放入 IP 数据报中，最后放入 MAC 帧中。

- 该帧的目的地址是请求主机的 MAC 地址，因为交换机具有自学习能力，之前主机发送了广播帧之后就记录了 MAC 地址到其转发接口的交换表项，因此现在交换机就可以直接知道应该向哪个接口发送该帧。

- 主机收到该帧后，不断分解得到 DHCP 报文。之后就配置它的 IP 地址、子网掩码和 DNS 服务器的 IP 地址，并在其 IP 转发表中安装默认网关。

## 2. ARP 解析 MAC 地址

- 主机通过浏览器生成一个 TCP 套接字，套接字向 HTTP 服务器发送 HTTP 请求。为了生成该套接字，主机需要知道网站的域名对应的 IP 地址。

- 主机生成一个 DNS 查询报文，该报文具有 53 号端口，因为 DNS 服务器的端口号是 53。

- 该 DNS 查询报文被放入目的地址为 DNS 服务器 IP 地址的 IP 数据报中。

- 该 IP 数据报被放入一个以太网帧中，该帧将发送到网关路由器。

- DHCP 过程只知道网关路由器的 IP 地址，为了获取网关路由器的 MAC 地址，需要使用 ARP 协议。

- 主机生成一个包含目的地址为网关路由器 IP 地址的 ARP 查询报文，将该 ARP 查询报文放入一个具有广播目的地址（FF:<zero-width space>FF:<zero-width space>FF:<zero-width space>FF:<zero-width space>FF:FF）的以太网帧中，并向交换机发送该以太网帧，交换机将该帧转发给所有的连接设备，包括网关路由器。

- 网关路由器接收到该帧后，不断向上分解得到 ARP 报文，发现其中的 IP 地址与其接口的 IP 地址匹配，因此就发送一个 ARP 回答报文，包含了它的 MAC 地址，发回给主机。

## 3. DNS 解析域名

- 知道了网关路由器的 MAC 地址之后，就可以继续 DNS 的解析过程了。

- 网关路由器接收到包含 DNS 查询报文的以太网帧后，抽取出 IP 数据报，并根据转发表决定该 IP 数据报应该转发的路由器。

- 因为路由器具有内部网关协议（RIP、OSPF）和外部网关协议（BGP）这两种路由选择协议，因此路由表中已经配置了网关路由器到达 DNS 服务器的路由表项。

- 到达 DNS 服务器之后，DNS 服务器抽取出 DNS 查询报文，并在 DNS 数据库中查找待解析的域名。

- 找到 DNS 记录之后，发送 DNS 回答报文，将该回答报文放入 UDP 报文段中，然后放入 IP 数据报中，通过路由器反向转发回网关路由器，并经过以太网交换机到达主机。

## 4. HTTP 请求页面

- 有了 HTTP 服务器的 IP 地址之后，主机就能够生成 TCP 套接字，该套接字将用于向 Web 服务器发送 HTTP GET 报文。

- 在生成 TCP 套接字之前，必须先与 HTTP 服务器进行三次握手来建立连接。生成一个具有目的端口 80 的 TCP SYN 报文段，并向 HTTP 服务器发送该报文段。

- HTTP 服务器收到该报文段之后，生成 TCP SYN ACK 报文段，发回给主机。

- 连接建立之后，浏览器生成 HTTP GET 报文，并交付给 HTTP 服务器。

- HTTP 服务器从 TCP 套接字读取 HTTP GET 报文，生成一个 HTTP 响应报文，将 Web 页面内容放入报文主体中，发回给主机。

- 浏览器收到 HTTP 响应报文后，抽取出 Web 页面内容，之后进行渲染，显示 Web 页面。
